# 事务 (Transaction)

构成单一逻辑工作单元的操作集合称为事务。事务要么整个执行，要么属于这个事务的操作
一个都不执行。事务具有以下几个特性：

* 原子性 (`Atomicity`)：事务的所有操作在数据库中要么全部正确反映出来，要么完全不反映。
* 一致性 (`Consistency`)：隔离执行事务时（换言之，在没有其他事务并发执行的情况下）
  保持数据库的一致性。事务执行前后，数据库都必须处于一致性状态。
* 隔离性 (`Isolation`)：尽管多个事务可能并发执行，但系统保证，对于任何一对事务
  T1 和 T2，在 T1 看来，T2 或者在 T1 开始之前已经完成执行，或者在 T1 完成之后开
  始执行。因此，每个事务都感觉不到系统中有其他事务在并发地执行。
* 持久性 (`Durability`)：一个事务完成后，它对数据库的改变必须是永久的，即使出现系统故障。

从一个转账的例子来看 `ACID`：

> T1:<br>
> read(A);<br>
> A := A - 50;<br>
> write(A);<br>
> read(B);<br>
> B := B - 50;<br>
> wrie(B).<br>

* 一致性：在这个情况，一致性要求事务不能改变 A、B 之和。如果没有一致性要求，金额
  可能被事务凭空创造或者销毁！
* 原子性：原子性要求从A中扣钱、往B中加钱是必须一起发生的，不能从A中扣了钱，但是不
  往B中加钱。某个事务的操作要么在数据库中全部反应出来，要么全部不反映。
* 持久性：系统必须保证任何系统故障都不会引起与这次转账相关的数据丢失。
* 隔离性：在有其他事务在并发执行的情况下，数据库需要保证这次的转账能正常进行。

## 事务隔离性级别

当数据库中有多事务同时运行的时候，可能会产生多种并发问题，其中包括脏读、不可重复
读和幻读。

* 脏读：当一个事务正在访问数据并对数据**做了修改但是没有提交**，这个时候，另外一个
  事务也访问这个数据，然后读取到了**未提交的数据**。
* 不可重复读：在一个事务内，**相同条件下**，**多次读取同一数据**，发现读取出来的
  **值不一样**。数据的修改。
* 幻读：当一个事务 A 要往数据库中插入一条数据，事务 A 先检查了一遍数据库，发现没
  有数据，然后执行插入操作。但是这事务 A 插入之前，事务 B 往表中插入了一条一样的
  数据，于是乎，事务 A 插入就会报错。数据的新增或者删除。

数据库隔离级别是为了有效保证并发读取数据的正确性提出的，**隔离性级别越高，越能保
证数据的完整性和一致性**。SQL 标准规定的隔离性级别如下：（从高到低）

* 可串行化 (`serializable`)：通常保证可串行化调度。上面所有的并发问题都不会发生，
  相当于锁表。
* 可重复读 (`repeatable read`)：只允许读取已提交的数据，而且在一个事务两次读取一
  个数据项期间，**其他事务不得更新该数据**。会出现**幻读**。
* 已提交读 (`read commited`)：只允许读取已提交的数据，但不要求可重复读。例如在事
  务两次读取一个数据项期间，另一个事务更新了改数据并提交。会出现**不可重复读**和
  **幻读**。
* 未提交读 (`read uncommited`)：允许读取未提交的数据。这个 SQL 允许的最低一致性
  级别。会出现**脏读**、**不可重复读**和**幻读**。

## 事务传播机制 (`Transaction Propagation`)

* `propagation required` (default): 如果当前有事务，支持当前事务（公用一个事务），
  如果没有事务的话，自己新建一个事务。
* `propagation supports`: 如果当前有事务，则支持当前事务；如果没有，以非事务的形式
  运行。
* `propagation mandatory`: 必须在事务中运行，如果没有事务，则抛出异常。说明它只能
  被一个父事务调用。
* `propagation required new`: 启动一个新的事务，如果已经存在事务，则挂起。这个两
  个是**单独的事务**（拥有自己的隔离范围，自己的锁等等）。
* `propagation not supported`: 不支持事务，如果有事务的话，将当前事务挂起。
* `propagation never`: 不支持事务，不能在事务中运行，如果存在事务的话，将抛出异常
* `propagation nested`: 开始一个 "嵌套的" 事务,  它是已经存在事务的一个真正的子事
  务. 潜套事务开始执行时,  它将取得一个 savepoint. 如果这个嵌套事务失败, 我们将回
  滚到此 savepoint. 潜套事务是外部事务的一部分, 只有外部事务结束后它才会被提交
